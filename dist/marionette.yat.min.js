/**
* @license
* Marionette.Yat extension for Backbone.Marionette
* Yet Another Toolkit
* ----------------------------------
* v0.0.5
*
* Distributed under MIT license
* author: dimtabu
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("underscore"),require("backbone"),require("backbone.marionette")):"function"==typeof define&&define.amd?define(["underscore","backbone","backbone.marionette"],e):t.MarionetteYat=e(t._,t.Backbone,t.Marionette)}(this,function(t,e,i){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t,e=e&&e.hasOwnProperty("default")?e.default:e,i=i&&i.hasOwnProperty("default")?i.default:i;var r=[e.Model,e.Collection,e.View,e.Router,i.Object];function n(e){var i=t.isFunction(e),n=t(r).some(function(t){return e===t||e.prototype instanceof t});return i&&n}function o(e){var r=e;r.extend||((r=extend.call(e,{})).extend=i.extend);return{with:function(){for(var e=arguments.length,i=Array(e),n=0;n<e;n++)i[n]=arguments[n];return t.reduce(i,function(e,i){return function(e,i){if(t.isFunction(i))return i(e);if(t.isObject(i))return e.extend(i);throw new YatError("Mixin fail, argument should be an object hash or mixin function")}(e,i)},r)}}}var a={isKnownCtor:n,mix:o};function s(t){return t.extend({getName:function(){return this.getProperty("name")||this.id||this.cid},getLabel:function(){return this.getProperty("label")||this.getName()}})}var u={normalizeOptions:function(e){return t.extend({},{deep:!0,force:!0,args:[]},e)},getDeepOptions:function(e){return t.extend({},e,{deep:!1,force:!1})},getValue:function(e,i){var r="getOption"===e?this:"getProperty"===e&&t.isObject(this.options)?this.getProperty("options",{deep:!1}):null;if(null!=r)return r[i]},getOptionPropertyValue:function(t,e,i){if(null!=t){var r=u.normalizeOptions(e),o=u.getDeepOptions(e),a=u.getValue.call(this,i,t);return void 0===a&&r.deep&&(a=this[i](t,o)),"function"!=typeof a||n(a)||!r.force?a:a.apply(this,r.args)}}},h=function(t){return t.extend({getProperty:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{deep:!0,force:!0,args:[]};return u.getOptionPropertyValue.call(this,t,e,"getOption")},getOption:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{deep:!0,force:!0,args:[]};return u.getOptionPropertyValue.call(this,t,e,"getProperty")}})},l=function(t){return t.extend({constructor:function(){for(var e=arguments.length,i=Array(e),r=0;r<e;r++)i[r]=arguments[r];t.apply(this,i);var n=!(!0===this.getProperty("initRadioOnInitialize"));this._initRadio({skip:n})},getChannel:function(){return this._channel||this._initRadio({skip:!1}),this._channel},_initRadio:function(){if(1!=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{skip:!0}).skip){if(!this.getProperty("channelName")){var t=this.getProperty("channel");t&&(this.channelName=t.channelName)}i.Object.prototype._initRadio.call(this)}},radioRequest:function(){var t=this.getChannel();t&&t.request.apply(t,arguments)},radioTrigger:function(){var t=this.getChannel();t&&t.trigger.apply(t,arguments)}})},c=function(e){var i=e.extend({constructor:function(){for(var t=arguments.length,i=Array(t),r=0;r<t;r++)i[r]=arguments[r];e.apply(this,i),this.initializeStateable()},initializeStateable:function(){this._state={}},getState:function(t){var e=this._state;return t?e[t]:e},setState:function(e,i,r){if(null!=e)if(t.isObject(e)){var n=this;r=i,t(i=e).each(function(t,e){return n.setState(e,t,r)}),this._triggerStateChange(i,r)}else{this.getState()[e]=i,this._triggerStateChange(e,i,r)}},clearState:function(){var e=this.getState(),i=t.extend({},e);t(e).each(function(t,r){i[r]=void 0,delete e[r]}),this._triggerStateChange(i)},_triggerStateChange:function(e,i,r){t.isFunction(this.triggerMethod)&&(t.isObject(e)?(r=i,i=e,this.triggerMethod("state",i,r)):(this.triggerMethod("state:"+e,i,r),!0!==i&&!1!==i||this.triggerMethod("state:"+e+":"+i.toString(),r)))}});return i.Stateable=!0,i},g=i.Error.extend({},{Http400:function(t){return this.Http(400,t)},Http401:function(t){return this.Http(401,t)},Http403:function(t){return this.Http(403,t)},Http404:function(t){return this.Http(404,t)},Http500:function(t){return this.Http(500,t)},Http:function(t,e){var i=new this({message:e,name:"HttpError"});return i.status=t,i},NotFound:function(t){return this.Http404(t)},NotAuthorized:function(t){return this.Http401(t)},Forbidden:function(t){return this.Http403(t)}}),f="initialized",d="starting",p="running",v="stopping",_="waiting",y="destroyed";function S(e,i){var r=this,n=e[i]||[],o=[];return t(n).each(function(e){t.isFunction(e)?o.push(e.call(r)):o.push(e)}),Promise.all(o)}function P(t,e,i){t[e]||(t[e]=[]);t[e].push(i)}var m=function(e){var i=o(e).with(c),r=i.extend({constructor:function(){for(var t=arguments.length,e=Array(t),r=0;r<t;r++)e[r]=arguments[r];i.apply(this,e),this.initializeStartable()},initializeStartable:function(){this.constructor.Startable&&this.constructor.Stateable&&(this._registerStartableLifecycleListeners(),this._setLifeState(f))},start:function(){for(var t=this,e=arguments.length,i=Array(e),r=0;r<e;r++)i[r]=arguments[r];var n=i[0],o=this._ensureStartableCanBeStarted(),a=null,s=null;if(o&&(s=function(){return t.triggerMethod("start:decline",o)},a=Promise.reject(o)),null==a){var u=this.isStartNotAllowed(n);u&&(s=function(){return t.triggerMethod("start:decline",u)},a=Promise.reject(u))}if(null==a){var h=this._getLifeState();this._tryMergeStartOptions(n),this.triggerMethod.apply(this,["before:start"].concat(i)),a=this._getStartPromise()}return a.then(function(){t.triggerStart(n)},function(e){return t._setLifeState(h),s&&s(),Promise.reject(e)})},triggerStart:function(t){this.triggerMethod("start",t)},stop:function(t){var e=this,i=this._ensureStartableCanBeStopped();if(i)return this.triggerMethod("stop:decline",i),Promise.reject(i);var r=this.isStopNotAllowed(t);if(r)return this.triggerMethod("stop:decline",r),Promise.reject(r);var n=this._getLifeState();this._tryMergeStopOptions(t),this.triggerMethod("before:stop",this,t);return this._getStopPromise().then(function(){e.triggerStop(t)},function(){e._setLifeState(n)})},triggerStop:function(t){this.triggerMethod("stop",t)},isStartNotAllowed:function(){},isStopNotAllowed:function(){},addStartPromise:function(t){P(this,"startPromises",t)},addStopPromise:function(t){P(this,"stopPromises",t)},_setLifeState:function(t){this.setState("life",t)},_getLifeState:function(){return this.getState("life")},_isLifeState:function(t){return this._getLifeState()===t},_isLifeStateIn:function(){for(var e=this,i=arguments.length,r=Array(i),n=0;n<i;n++)r[n]=arguments[n];return t(r).some(function(t){return e._isLifeState(t)})},_isInProcess:function(){return this._isLifeStateIn(d,v)},_registerStartableLifecycleListeners:function(){var t=this;this.on("before:start",function(){return t._setLifeState(d)}),this.on("start",function(){return t._setLifeState(p)}),this.on("before:stop",function(){return t._setLifeState(v)}),this.on("stop",function(){return t._setLifeState(_)}),this.on("destroy",function(){return t._setLifeState(y)})},_tryMergeStartOptions:function(t){if(this.mergeOptions){var e=this.getProperty("mergeStartOptions")||[];this.mergeOptions(t,e)}},_tryMergeStopOptions:function(t){if(this.mergeOptions){var e=this.getProperty("mergeStopOptions")||[];this.mergeOptions(t,e)}},_ensureStartableIsIntact:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{throwError:!1},e=new g({name:"StartableLifecycleError",message:"Startable has already been destroyed and cannot be used."}),i=this._isLifeState(y);if(t.throwError&&i)throw e;if(i)return e},_ensureStartableIsIdle:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{throwError:!1},e="Startable is not idle. current state: "+this._getLifeState(),i=new g({name:"StartableLifecycleError",message:e}),r=this._ensureStartableIsIntact(t),n=this._isInProcess();if(t.throwError&&n)throw i;return r||(n?i:void 0)},_ensureStartableCanBeStarted:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{throwError:!1},e=new g({name:"StartableLifecycleError",message:"Startable has already been started."}),i=this._ensureStartableIsIdle(t),r=!0===this.getProperty("allowStartWithoutStop");if(i||!r){var n=this._isLifeState(p);if(t.throwError&&n)throw e;return i||(n?e:void 0)}},_ensureStartableCanBeStopped:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{throwError:!1},e=new g({name:"StartableLifecycleError",message:"Startable should be in `running` state."}),i=this._ensureStartableIsIdle(t),r=!0===this.getProperty("allowStopWithoutStart");if(i||!r){var n=this._isLifeState(p);if(t.throwError&&!n)throw e;return i||(n?void 0:e)}},_getStartPromise:function(){return Promise.all(this._getStartPromises())},_getStartPromises:function(){var t=[];return t.push(this._getStartUserPromise()),t.push(this._getStartParentPromise()),t},_getStartUserPromise:function(){return S(this,"startPromises")},_getStartParentPromise:function(){var e=t.result(this,"getParent");if(t.isObject(e)&&t.isFunction(e._getStartPromise))return e._getStartPromise()},_getStopPromise:function(){return Promise.all(this._getStopPromises())},_getStopPromises:function(){var t=[];return t.push(this._getStopUserPromise()),t},_getStopUserPromise:function(){return S(this,"stopPromises")},_getStopParentPromise:function(){var e=t.result(this,"getParent");if(t.isObject(e)&&t.isFunction(e._getStopPromise))return e._getStartPromise()}});return r.Startable=!0,r},b=function(e){var i="_children",r=e.extend({constructor:function(){for(var t=arguments.length,i=Array(t),r=0;r<t;r++)i[r]=arguments[r];e.apply(this,i),this.initializeChildrenable.apply(this,i)},initializeChildrenable:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._initializeParrent(t),this._initializeChildren(t)},hasChildren:function(){this.getChildren();return this[i].length>0},getChildren:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{startable:!0},e=this[i]||[];return t.startable?e.filter(function(t){return!t.getProperty("isStartNotAllowed")}):e},hasParent:function(){var e=this.getParent();return t.isObject(e)},getParent:function(){return this.getProperty("parent",{deep:!1})},_initializeChildren:function(){var e=this,r=this.getProperty("children"),n=[];t(r).each(function(t){var i=e._normalizeChildContext(t),r=e._initializeChild(i);r&&n.push(r)}),this[i]=n},_initializeChild:function(e){if(null!=e&&t.isFunction(e.Child)){var i=e.Child,r=this._normalizeChildOptions(e);return this.buildChild(i,r)}},_normalizeChildContext:function(e){var i={};return t.isFunction(e)&&e.Childrenable?t.extend(i,{Child:e}):t.isFunction(e)?i=this._normalizeChildContext(e.call(this)):t.isObject(e)&&(i=e),i},_normalizeChildOptions:function(e){var i=t.extend({},e);return!0===this.getOption("passToChildren")&&t.extend(i,this.options),i.parent=this,delete i.Child,this._buildChildOptions(i)},_buildChildOptions:function(e){return t.extend(e,this.getProperty("childOptions"))},buildChild:function(t,e){return new t(e)},_initializeParrent:function(t){null==this.parent&&null!=t.parent&&(this.parent=t.parent)}});return r.Childrenable=!0,r},M={GetNameLabel:s,GetOptionProperty:h,Radioable:l,Stateable:c,Startable:m,Childrenable:b},w=o(i.Object).with(h,l),O=o(w).with(c),C=new(O.extend({constructor:function(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];O.apply(this,e),this._initializeYatUser()},_initializeYatUser:function(){},channelName:"identity",isAnonym:function(){return!this.getState("id")},isUser:function(){return!this.isAnonym()},isMe:function(t){return t&&this.getState("id")===t},update:function(t){this.setState(t),this.trigger("change")},logIn:function(t){t.id&&(this.update(t),this.trigger("log:in"))},logOut:function(){this.clearState(),this.trigger("change"),this.trigger("log:out")}})),x=o(i.Application).with(h,l,b,m),L=x.extend({initRadioOnInitialize:!0,_initRegion:function(){if(!(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{skip:!0}).skip){var t=this.getProperty("region");this.region=t,x.prototype._initRegion()}},getRegion:function(){return this._region||this._initRegion({skip:!1}),this._region},addPageManager:function(t){var e=this;this._pageManagers||(this._pageManagers=[]),this._pageManagers.push(t);var i=t.getName();i?this.listenTo(t,"all",function(t){for(var r=arguments.length,n=Array(r>1?r-1:0),o=1;o<r;o++)n[o-1]=arguments[o];var a=i+":"+t;e.triggerMethod.apply(e,[a].concat(n))}):console.warn("pageManager prefix not defined")},hasPageManagers:function(){return this._pageManagers&&this._pageManagers.length>0},getMenuTree:function(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{rebuild:!1};if(this._menuTree&&!i.rebuild)return this._menuTree;var r=this._pageManagers||[],n=t(r).chain().map(function(t){return t.getLinks()}).flatten().value();return this._menuTree=new e.Collection(n),this._menuTree},getPage:function(e){if(this.hasPageManagers())return t(this._pageManagers).find(function(t){return t.getPage(e)})}}),R=i.AppRouter.extend({},{create:function(e,i){var r=this,n={},o={};return t(e).each(function(t,e){n[e]=e,o[e]=function(){t.action.apply(t,arguments).catch(function(t){var e="error"+(t.status&&":"+t.status);"error"!=e&&i.triggerMethod(e,t,r),i.triggerMethod("error",t,r)})}}),new this({controller:o,appRoutes:n})}}),A=e.Model.extend({}),k=A.extend({defaults:{url:void 0,label:void 0,target:"_self",level:0},destroy:function(){this.id=null,A.prototype.destroy.apply(this,arguments)}});function H(t){if(Array.isArray(t)){for(var e=0,i=Array(t.length);e<t.length;e++)i[e]=t[e];return i}return Array.from(t)}var z=o(L).with(s),I=z.extend({constructor:function(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];z.apply(this,e),this.initializeYatPage()},allowStopWithoutStart:!0,allowStartWithoutStop:!0,initializeYatPage:function(t){this.mergeOptions(t,["manager"]),this._initializeModels(t),this._initializeRoute(t),this._proxyEvents(),this._tryCreateRouter(),this._registerIdentityHandlers()},getLayout:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{rebuild:!1};return(!this._layoutView||t.rebuild||this._layoutView&&this._layoutView.isDestroyed&&this._layoutView.isDestroyed())&&this.buildLayout(),this._layoutView},buildLayout:function(){var e=this.getProperty("Layout");if(null!=e){var i=t.extend({},this.getProperty("layoutOptions"));this.model&&!i.model&&t.extend(i,{model:this.model}),this.collection&&!i.collection&&t.extend(i,{collection:this.collection});var r=this.buildLayoutOptions(i);return r.page=this,this._layoutView=new e(r),this._layoutView}},buildLayoutOptions:function(t){return t},addModel:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(t){this.model=t;var i=e.fetch||this.getOption("fetchModelOnAdd");void 0===i&&(i=this.getProperty("fetchDataOnAdd")),!0===i&&this.addStartPromise(t.fetch(e))}},addCollection:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(t){this.collection=t;var i=e.fetch||this.getOption("fetchCollectionOnAdd");void 0===i&&(i=this.getProperty("fetchDataOnAdd")),!0===i&&this.addStartPromise(t.fetch(e))}},getRouteHash:function(){var e=[{},this._routeHandler].concat(this.getChildren({startable:!1}).map(function(t){return t.getRouteHash()}));return t.extend.apply(t,H(e))},hasRouteHash:function(){return t.isObject(this.getRouteHash())},getLinkModel:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(this._canHaveLinkModel()){if(this._linkModel)return this._linkModel;var e=this.getRoute(),i=this.getLabel(),r=this._getSublinks(t);return this._linkModel=new k({url:e,label:i,level:t,children:r}),this._linkModel}},_canHaveLinkModel:function(){return!(!0===this.getProperty("skipMenu")||this.getProperty("isStartNotAllowed"))},_destroyLinkModel:function(){this._linkModel&&(this._linkModel.destroy(),delete this._linkModel)},getParentLinkModel:function(){var t=this.getParent();if(t&&t.getLinkModel){return t.getLinkModel()}},getNeighbourLinks:function(){var t=this.getLinkModel();if(t&&t.collection)return t.collection},_getSublinks:function(i){var r=this.getChildren();if(r&&r.length){var n=t(r).chain().filter(function(t){return!0!==t.getProperty("skipMenu")}).map(function(t){return t.getLinkModel(i+1)}).value();if(n.length){return new e.Collection(n)}}},_initializeModels:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.addModel(t.model,t),this.addCollection(t.collection,t)},_initializeRoute:function(){var t=this.getRoute();if(null!=t){var e=this;this._routeHandler=(i={},r=t,n={context:e,action:function(){return e.start.apply(e,arguments)}},r in i?Object.defineProperty(i,r,{value:n,enumerable:!0,configurable:!0,writable:!0}):i[r]=n,i);var i,r,n}},getRoute:function(){var t=this.getProperty("relativeRoute"),e=this.getProperty("route"),i=this.getParent();if(null!=e){if(!t||!i||!i.getRoute)return e;var r=i.getRoute();if(null==r)return e;var n=r+"/"+e;return n.startsWith("/")&&(n=n.substring(1)),n}},_tryCreateRouter:function(){!0===this.getProperty("createRouter")&&(this.router=this._createAppRouter())},_createAppRouter:function(){var e=this.getRouteHash();if(t.size(e))return new R(e)},_proxyEvents:function(){var t=this._getProxyContexts();this._proxyEventsTo(t)},_getProxyContexts:function(){var t=[],e=this.getProperty("manager");e&&t.push({context:e});var i=this.getChannel();if(i){var r=this.getProperty("proxyEventsToRadio");t.push({context:i,allowed:r})}return t},_proxyEventsTo:function(e){var i=[],r={};t(e).each(function(e){e.allowed?t(e.allowed).each(function(t){r[t]||(r[t]=[]),r[t].push(e.context)}):i.push(e.context)});var n=this;n.on("all",function(e){for(var o=arguments.length,a=Array(o>1?o-1:0),s=1;s<o;s++)a[s-1]=arguments[s];var u=e in r?r[e]:i,h=[n].concat(a);t(u).each(function(t){return t.triggerMethod.apply(t,["page:"+e].concat(H(h)))})})},_buildChildOptions:function(e){var i={},r=this.getProperty("manager");return r&&(i.manager=r),t.extend(e,this.getProperty("childOptions"),i)},_registerIdentityHandlers:function(){var t=this;this.listenTo(C,"change",function(){for(var e=arguments.length,i=Array(e),r=0;r<e;r++)i[r]=arguments[r];t._destroyLinkModel(),t.triggerMethod.apply(t,["identity:change"].concat(i))})}}),E=o(L).with(s),N=E.extend({constructor:function(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];E.apply(this,e),this._initializeYatPageManager.apply(this,e)},createRouter:function(){var e=this.getChildren({startable:!1}),i={};t(e).each(function(e){t.isFunction(e.getRouteHash)&&t.extend(i,e.getRouteHash())}),this._routesHash=i,this.setRouter(R.create(i,this))},setRouter:function(t){this.router=t},getRouter:function(){return this.router},getLinks:function(){var e=this.getChildren();if(e)return t(e).chain().map(function(t){return t.getLinkModel()}).filter(function(t){return!!t}).value()},navigate:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{trigger:!0},i=this.getRouter();i&&i.navigate(t,e)},getPage:function(e){var i=t(this._routesHash).find(function(t,i){return i===e||(t.context.getName()===e||void 0)});return i&&i.context},navigateToRoot:function(){var t=this.getState("currentPage"),e=this.getProperty("rootUrl");if(!e){var i=this.getChildren();if(!i||!i.length)return;var r=i.find(function(e){return e!=t});e=r&&r.getRoute()}e&&this.navigate(e)},_initializeYatPageManager:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.mergeOptions(t,["id","name","label"]),this._registerPageHandlers(t),this._registerIdentityHandlers(),this.createRouter()},_buildChildOptions:function(e){return t.extend(e,this.getProperty("childOptions"),{manager:this})},_registerPageHandlers:function(){this.on("page:before:start",this._pageBeforeStart),this.on("page:start",this._pageStart),this.on("page:decline",this._pageDecline)},_pageBeforeStart:function(t){var e=this.getState("currentPage");e&&e!=t&&e.stop()},_pageStart:function(t){this.setState("currentPage",t)},_pageDecline:function(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];console.log("decline",e)},_registerIdentityHandlers:function(){var t=this;this.listenTo(C,"change",function(){for(var e=arguments.length,i=Array(e),r=0;r<e;r++)i[r]=arguments[r];t.triggerMethod.apply(t,["identity:change"].concat(i)),t._moveToRootIfCurrentPageNotAllowed()})},_moveToRootIfCurrentPageNotAllowed:function(){var t=this.getState("currentPage");t&&t.isStartNotAllowed()&&this.navigateToRoot()}});return{VERSION:"0.0.5",Helpers:a,Mixins:M,Object:w,Error:g,App:L,Page:I,Router:R,PageManager:N,identity:C}}),this&&this.Marionette&&(this.Marionette.Yat=this.MarionetteYat);
//# sourceMappingURL=marionette.yat.min.js.map